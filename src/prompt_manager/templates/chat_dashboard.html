<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Prompt Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Top Navigation Bar */
        .navbar {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 20px;
            color: #1a202c;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn-nav {
            padding: 8px 16px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #4a5568;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-nav:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: #f7fafc;
            color: #4a5568;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .btn-icon:hover {
            background: #edf2f7;
            color: #2d3748;
        }

        /* Main Container */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Collapsible Control Panel */
        .control-panel {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .control-panel.collapsed .panel-content {
            display: none;
        }
        
        .control-panel.collapsed {
            border-bottom: 1px solid #e2e8f0;
        }

        .panel-content {
            padding: 16px 24px;
        }

        .controls-row {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 200px;
        }

        .control-label {
            font-size: 12px;
            font-weight: 600;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .model-select {
            padding: 10px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #2d3748;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%234299e1' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 40px;
        }

        .model-select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
            min-width: 180px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slider-value {
            font-size: 13px;
            font-weight: 700;
            color: #667eea;
            padding: 2px 8px;
            background: #ebf8ff;
            border-radius: 4px;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 10px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            border: none;
        }

        .quick-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-action {
            padding: 8px 14px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #4a5568;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-action:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
            transform: translateY(-1px);
        }

        /* Toggle Button */
        .toggle-panel-btn {
            width: 100%;
            padding: 8px;
            background: #f7fafc;
            border: none;
            border-top: 1px solid #e2e8f0;
            color: #718096;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-panel-btn:hover {
            background: #edf2f7;
            color: #4a5568;
        }
        
        .control-panel.collapsed .toggle-panel-btn {
            border-top: none;
            border-bottom: 1px solid #e2e8f0;
        }

        /* Token usage display */
        .token-usage {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            background: #f7fafc;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        .token-bar-container {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .token-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78 0%, #ed8936 50%, #fc8181 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
            background-size: 200% 100%;
        }

        .token-bar-fill.low {
            background-position: 0% 0%;
        }

        .token-bar-fill.medium {
            background-position: 50% 0%;
        }

        .token-bar-fill.high {
            background-position: 100% 0%;
        }

        .token-label {
            font-size: 12px;
            font-weight: 600;
            color: #4a5568;
            min-width: 100px;
        }

        .token-percentage {
            font-size: 13px;
            font-weight: 700;
            color: #667eea;
            min-width: 50px;
            text-align: right;
        }

        .token-warning {
            font-size: 11px;
            color: #ed8936;
            font-weight: 600;
        }

        /* Chat Area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: white;
        }

        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .user-avatar {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        }

        .assistant-avatar {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .system-avatar {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .message-content {
            flex: 1;
            max-width: 700px;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .message-sender {
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
        }

        .message-time {
            font-size: 12px;
            color: #a0aec0;
        }

        .message-text {
            background: white;
            padding: 16px;
            border-radius: 12px;
            line-height: 1.6;
            color: #2d3748;
            border: 1px solid #e2e8f0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message.user .message-text {
            background: #ebf8ff;
            border-color: #bee3f8;
        }

        .message.system .message-text {
            background: #fef5e7;
            border-color: #f6e05e;
            font-style: italic;
        }

        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .btn-msg-action {
            padding: 4px 10px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            color: #718096;
            transition: all 0.3s ease;
        }

        .btn-msg-action:hover {
            background: #f7fafc;
            color: #4a5568;
        }

        /* Input Area */
        .input-container {
            padding: 20px 24px;
            border-top: 1px solid #e2e8f0;
            background: white;
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .prompt-library-btn {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            background: white;
            color: #4a5568;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .prompt-library-btn:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
        }

        .input-box {
            flex: 1;
            position: relative;
        }

        .chat-input {
            width: 100%;
            min-height: 44px;
            max-height: 150px;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-family: inherit;
            font-size: 15px;
            resize: none;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .btn-send {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .input-hint {
            margin-top: 8px;
            font-size: 12px;
            color: #a0aec0;
            text-align: center;
        }

        /* Loading indicator */
        .loading-indicator {
            display: none;
            padding: 12px;
            text-align: center;
            color: #718096;
        }

        .loading-indicator.active {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 16px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success {
            border-left: 4px solid #48bb78;
        }

        .notification.error {
            border-left: 4px solid #fc8181;
        }

        @media (max-width: 768px) {
            .controls-row {
                flex-direction: column;
            }
            
            .control-group, .slider-group {
                width: 100%;
            }

            .quick-actions {
                width: 100%;
            }

            .btn-action {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar">
        <div class="nav-left">
            <div class="logo">
                <div class="logo-icon">üí¨</div>
                <span>Prompt Manager</span>
            </div>
        </div>
        <div class="nav-right">
            <button class="btn-nav" onclick="window.location.href='/template-builder'">
                <span>üìù</span>
                <span>Templates</span>
            </button>
            <button class="btn-nav" id="chat-history-btn">
                <span>üìú</span>
                <span>History</span>
            </button>
            <button class="btn-icon" title="Prompts Library" onclick="window.location.href='/prompts'">üìö</button>
            <button class="btn-icon" title="Settings" onclick="window.location.href='/settings'">‚öôÔ∏è</button>
        </div>
    </nav>

    <div class="main-container">
        <!-- Collapsible Control Panel -->
        <div class="control-panel" id="control-panel">
            <div class="panel-content">
                <!-- Primary Controls -->
                <div class="controls-row">
                    <div class="control-group">
                        <label class="control-label">Model</label>
                        <select class="model-select" id="model-select">
                            <option value="gpt-4-turbo-preview">GPT-4 Turbo (Recommended)</option>
                            <option value="gpt-4">GPT-4 (Most Capable)</option>
                            <option value="gpt-3.5-turbo" selected>GPT-3.5 Turbo (Fast & Efficient)</option>
                            <option value="gpt-3.5-turbo-16k">GPT-3.5 Turbo 16K (Long Context)</option>
                        </select>
                    </div>

                    <div class="slider-group">
                        <div class="slider-header">
                            <label class="control-label" title="üí° Controls creativity: 0 = focused, 1 = balanced, 2 = very creative">Temperature ‚ÑπÔ∏è</label>
                            <span class="slider-value" id="temp-value">0.7</span>
                        </div>
                        <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" 
                               title="Controls response creativity">
                    </div>

                    <div class="slider-group">
                        <div class="slider-header">
                            <label class="control-label" title="üí° Maximum length of AI response (not conversation context). Lower = shorter responses.">Max Tokens ‚ÑπÔ∏è</label>
                            <span class="slider-value" id="tokens-value">2048</span>
                        </div>
                        <input type="range" id="max-tokens" min="50" max="4096" step="50" value="2048"
                               title="Maximum response length (separate from context window)">
                    </div>
                </div>

                <!-- Conversation Metadata -->
                <div class="controls-row" style="padding: 12px; background: #f7fafc; border-radius: 8px; margin-top: 8px;">
                    <div style="display: flex; gap: 15px; font-size: 12px; color: #4a5568; flex-wrap: wrap;">
                        <span title="Total messages in this conversation">üí¨ <strong id="msg-count">0</strong> msgs</span>
                        <span title="Current AI model being used">ü§ñ <strong id="model-name">-</strong></span>
                        <span title="Conversation start time">üïê <strong id="conv-time">-</strong></span>
                        <span title="Last message timestamp">üìÖ <strong id="last-msg-time">-</strong></span>
                        <span title="Estimated cost based on token usage" id="cost-estimate" style="display: none;">üí∞ ~$<strong id="cost-value">0.00</strong></span>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="controls-row">
                    <div class="quick-actions">
                        <button class="btn-action" id="prompts-btn">
                            <span>üìö</span>
                            <span>Prompts</span>
                        </button>
                        <button class="btn-action" id="regenerate-btn" disabled>
                            <span>üîÑ</span>
                            <span>Regenerate</span>
                        </button>
                        <button class="btn-action" id="save-prompt-btn">
                            <span>üíæ</span>
                            <span>Save</span>
                        </button>
                        <button class="btn-action" id="export-btn">
                            <span>üì§</span>
                            <span>Export</span>
                        </button>
                        <button class="btn-action" id="clear-btn">
                            <span>üóëÔ∏è</span>
                            <span>Clear</span>
                        </button>
                    </div>
                </div>

                <!-- Token Usage Display -->
                <div class="controls-row">
                    <div class="token-usage" id="token-usage">
                        <span class="token-label">Context Usage:</span>
                        <div class="token-bar-container">
                            <div class="token-bar-fill low" id="token-bar" style="width: 0%"></div>
                        </div>
                        <span class="token-percentage" id="token-percentage">0%</span>
                        <span class="token-warning" id="token-warning" style="display: none;"></span>
                    </div>
                </div>
            </div>
            <button class="toggle-panel-btn" id="toggle-panel-btn" onclick="togglePanel()">
                ‚ñ≤ Hide Controls
            </button>
        </div>

        <!-- Chat Container -->
        <div class="chat-container">
            <div class="messages-area" id="messages-area">
                <div class="message system">
                    <div class="message-avatar system-avatar">‚ÑπÔ∏è</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">System</span>
                            <span class="message-time" id="welcome-time"></span>
                        </div>
                        <div class="message-text">Welcome to Prompt Manager! Select a model above and start chatting. Use the üìö Prompts button to insert saved prompts.</div>
                    </div>
                </div>
            </div>

            <div class="loading-indicator" id="loading-indicator">
                <span class="spinner"></span>
                <span style="margin-left: 10px;">Thinking...</span>
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-wrapper">
                    <button class="prompt-library-btn" id="prompt-lib-btn" title="Open Prompt Library">üìö</button>
                    <div class="input-box">
                        <textarea 
                            class="chat-input" 
                            id="chat-input"
                            placeholder="Type your message here... (Enter for new line, click Send to submit)"
                            rows="3"
                        ></textarea>
                    </div>
                    <button class="btn-send" id="send-btn" title="Send Message">üöÄ</button>
                </div>
                <div class="input-hint">
                    Enter for new line ‚Ä¢ Click üöÄ to send message
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 16px; width: 90%; max-width: 700px; max-height: 80vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <div style="padding: 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="font-size: 24px; color: #1a202c; margin: 0;">üí¨ Conversation History</h2>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button onclick="deleteAllConversations()" 
                            style="padding: 8px 16px; background: #fff5f5; color: #e53e3e; border: 1px solid #feb2b2; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px;">
                        üóëÔ∏è Delete All
                    </button>
                    <button onclick="closeHistoryModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #718096;">√ó</button>
                </div>
            </div>
            <div id="history-list" style="padding: 24px; overflow-y: auto; max-height: calc(80vh - 120px);">
                <div style="text-align: center; color: #718096; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üìú</div>
                    <div>Loading conversations...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prompts Library Modal -->
    <div id="prompts-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 16px; width: 90%; max-width: 700px; max-height: 80vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <div style="padding: 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="font-size: 24px; color: #1a202c; margin: 0;">üìö Prompt Library</h2>
                <button onclick="closePromptsModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #718096;">√ó</button>
            </div>
            <div style="padding: 16px 24px; border-bottom: 1px solid #e2e8f0;">
                <input type="text" id="prompt-search" placeholder="üîç Search prompts..." 
                       style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;"
                       onkeyup="filterPrompts()">
            </div>
            <div id="prompts-list" style="padding: 24px; overflow-y: auto; max-height: calc(80vh - 200px);">
                <div style="text-align: center; color: #718096; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üìö</div>
                    <div>Loading prompts...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Conversation Modal -->
    <div id="save-conv-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 16px; width: 90%; max-width: 500px; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <div style="padding: 24px; border-bottom: 1px solid #e2e8f0;">
                <h2 style="font-size: 24px; color: #1a202c; margin: 0;">üíæ Save Conversation</h2>
            </div>
            <div style="padding: 24px;">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 8px;">Conversation Title</label>
                    <input type="text" id="conv-title-input" placeholder="Enter a title for this conversation..." 
                           style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;">
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeSaveConvModal()" 
                            style="padding: 10px 20px; background: #f7fafc; color: #4a5568; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 500;">
                        Cancel
                    </button>
                    <button onclick="saveConversationWithTitle()" 
                            style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                        üíæ Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        let messages = [];
        let currentProvider = 'openai';
        let isLoading = false;
        let currentConversationId = null;
        let systemPrompt = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateWelcomeTime();
            loadSystemPrompt();
            loadChatHistory();
        });

        function setupEventListeners() {
            // Slider updates
            document.getElementById('temperature').addEventListener('input', function() {
                document.getElementById('temp-value').textContent = this.value;
            });

            document.getElementById('max-tokens').addEventListener('input', function() {
                document.getElementById('tokens-value').textContent = this.value;
            });
            
            // Model selection change
            document.getElementById('model-select').addEventListener('change', function() {
                updateConversationMetadata();
            });

            // Input handling
            const chatInput = document.getElementById('chat-input');
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });

            // Enter creates new line - no special handling needed
            // Only Send button submits message

            // Button handlers
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('clear-btn').addEventListener('click', clearChat);
            document.getElementById('export-btn').addEventListener('click', exportChat);
            document.getElementById('prompts-btn').addEventListener('click', openPromptLibrary);
            document.getElementById('prompt-lib-btn').addEventListener('click', openPromptLibrary);
            document.getElementById('chat-history-btn').addEventListener('click', openHistoryModal);
            document.getElementById('regenerate-btn').addEventListener('click', regenerateLastResponse);
            document.getElementById('save-prompt-btn').addEventListener('click', openSaveConvModal);
        }

        function togglePanel() {
            const panel = document.getElementById('control-panel');
            const btn = document.getElementById('toggle-panel-btn');
            
            panel.classList.toggle('collapsed');
            
            if (panel.classList.contains('collapsed')) {
                btn.textContent = '‚ñº Show Controls';
            } else {
                btn.textContent = '‚ñ≤ Hide Controls';
            }
        }

        async function sendMessage(providedMessage = null) {
            // If called from button click, providedMessage will be the event object
            // Only use providedMessage if it's a string
            const input = document.getElementById('chat-input');
            const message = (typeof providedMessage === 'string' && providedMessage) 
                ? providedMessage 
                : input.value.trim();
            
            if (!message || isLoading) return;

            // Add user message
            addMessage('user', message);
            input.value = '';
            input.style.height = 'auto';

            // Get settings
            const model = document.getElementById('model-select').value;
            const temperature = parseFloat(document.getElementById('temperature').value);
            const maxTokens = parseInt(document.getElementById('max-tokens').value);

            // Build history (exclude system messages and welcome message)
            const history = messages
                .filter(msg => msg.type !== 'system')
                .map(msg => ({
                    role: msg.type === 'user' ? 'user' : 'assistant',
                    content: msg.content
                }));

            // Show loading
            isLoading = true;
            document.getElementById('loading-indicator').classList.add('active');
            document.getElementById('send-btn').disabled = true;

            try {
                const response = await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        provider: currentProvider,
                        model: model,
                        temperature: temperature,
                        max_tokens: maxTokens,
                        history: history,
                        system_prompt: systemPrompt,
                        auto_trim: true
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    addMessage('assistant', result.response);
                    
                    // Update token usage display
                    updateTokenUsage(result.token_usage);
                    
                    // Show warning if context is filling
                    if (result.token_usage.warning) {
                        showNotification(result.token_usage.warning, 'warning');
                    }
                    
                    // Show trimming notice
                    if (result.trimmed) {
                        showNotification(`Auto-trimmed ${result.trimmed} old messages to fit context`, 'success');
                    }
                    
                    // Auto-save conversation
                    await saveConversationAuto();
                } else {
                    const error = await response.json();
                    addMessage('system', `Error: ${error.error || 'Failed to send message'}`);
                }
            } catch (error) {
                addMessage('system', `Network error: ${error.message}`);
            } finally {
                isLoading = false;
                document.getElementById('loading-indicator').classList.remove('active');
                document.getElementById('send-btn').disabled = false;
            }
        }

        function addMessage(type, content) {
            const messagesArea = document.getElementById('messages-area');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const avatarClass = type === 'user' ? 'user-avatar' : 
                               type === 'assistant' ? 'assistant-avatar' : 'system-avatar';
            const avatarIcon = type === 'user' ? 'üë§' : 
                              type === 'assistant' ? 'ü§ñ' : '‚ÑπÔ∏è';
            const sender = type === 'user' ? 'You' : 
                          type === 'assistant' ? 'Assistant' : 'System';

            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            messageDiv.innerHTML = `
                <div class="message-avatar ${avatarClass}">${avatarIcon}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">${sender}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${escapeHtml(content)}</div>
                    ${type !== 'system' ? `
                    <div class="message-actions">
                        <button class="btn-msg-action" onclick="copyMessage(this)">üìã Copy</button>
                        <button class="btn-msg-action" onclick="saveAsPrompt(this)">üíæ Save as Prompt</button>
                    </div>
                    ` : ''}
                </div>
            `;

            messagesArea.appendChild(messageDiv);
            messagesArea.scrollTop = messagesArea.scrollHeight;

            messages.push({ type, content, time: new Date().toISOString() });
            
            // Update regenerate button state and all metadata
            updateRegenerateButton();
            updateConversationMetadata();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function clearChat() {
            if (messages.length <= 1) return; // Don't clear if only welcome message
            
            if (confirm('Are you sure you want to clear this chat?')) {
                const messagesArea = document.getElementById('messages-area');
                messagesArea.innerHTML = '';
                messages = [];
                // Re-add welcome message
                updateWelcomeTime();
                const welcomeMsg = messagesArea.querySelector('.message.system');
                if (welcomeMsg) {
                    messages.push({ 
                        type: 'system', 
                        content: welcomeMsg.querySelector('.message-text').textContent,
                        time: new Date().toISOString()
                    });
                }
                showNotification('Chat cleared successfully', 'success');
            }
        }

        function exportChat() {
            if (messages.length <= 1) {
                showNotification('No messages to export', 'error');
                return;
            }

            let exportText = 'Chat Export - Prompt Manager\n';
            exportText += '=' .repeat(50) + '\n\n';

            messages.forEach(msg => {
                const time = new Date(msg.time).toLocaleString();
                const sender = msg.type === 'user' ? 'You' : 
                              msg.type === 'assistant' ? 'Assistant' : 'System';
                exportText += `[${time}] ${sender}:\n${msg.content}\n\n`;
            });

            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('Chat exported successfully', 'success');
        }

        function copyMessage(button) {
            const messageText = button.closest('.message-content').querySelector('.message-text').textContent;
            navigator.clipboard.writeText(messageText).then(() => {
                showNotification('Message copied to clipboard', 'success');
            });
        }

        async function saveAsPrompt(button) {
            const messageText = button.closest('.message-content').querySelector('.message-text').textContent;
            
            // Prompt for a name
            const name = prompt('Enter a name for this prompt:');
            if (!name) return;
            
            try {
                const response = await fetch('/api/prompts', {  // Changed from /api/prompt to /api/prompts
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        text: messageText,  // Changed from 'content' to 'text' to match API
                        category: 'chat-saved',
                        tags: ['chat']
                    })
                });
                
                if (response.ok) {
                    showNotification('Prompt saved successfully!', 'success');
                } else {
                    const error = await response.json();
                    showNotification(`Failed to save: ${error.error}`, 'error');
                }
            } catch (error) {
                showNotification(`Error saving prompt: ${error.message}`, 'error');
            }
        }

        // Prompts Library Modal Functions
        let allPrompts = [];
        
        async function openPromptLibrary() {
            const modal = document.getElementById('prompts-modal');
            modal.style.display = 'flex';
            
            // Load prompts
            await loadPromptsList();
        }

        function closePromptsModal() {
            const modal = document.getElementById('prompts-modal');
            modal.style.display = 'none';
        }

        async function loadPromptsList() {
            const listContainer = document.getElementById('prompts-list');
            
            try {
                const response = await fetch('/api/prompts');
                
                if (response.ok) {
                    const data = await response.json();
                    allPrompts = data.prompts || [];
                    
                    if (allPrompts.length === 0) {
                        listContainer.innerHTML = `
                            <div style="text-align: center; color: #718096; padding: 40px;">
                                <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
                                <div style="font-size: 18px; margin-bottom: 8px;">No saved prompts yet</div>
                                <div style="font-size: 14px;">Prompts you save will appear here!</div>
                            </div>
                        `;
                        return;
                    }
                    
                    // Render prompts
                    renderPromptsList(allPrompts);
                } else {
                    listContainer.innerHTML = `
                        <div style="text-align: center; color: #e53e3e; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                            <div>Failed to load prompts</div>
                        </div>
                    `;
                }
            } catch (error) {
                listContainer.innerHTML = `
                    <div style="text-align: center; color: #e53e3e; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                        <div>Error: ${error.message}</div>
                    </div>
                `;
            }
        }

        function renderPromptsList(prompts) {
            const listContainer = document.getElementById('prompts-list');
            
            listContainer.innerHTML = prompts.map(prompt => `
                <div style="border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-bottom: 12px; background: white; transition: all 0.2s ease;"
                     onmouseover="this.style.background='#f7fafc'; this.style.borderColor='#cbd5e0';"
                     onmouseout="this.style.background='white'; this.style.borderColor='#e2e8f0';">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <div style="font-weight: 600; color: #1a202c; font-size: 16px; margin-bottom: 4px;">${prompt.name || 'Untitled'}</div>
                            ${prompt.category ? `<span style="display: inline-block; padding: 4px 12px; background: #edf2f7; color: #4a5568; border-radius: 12px; font-size: 12px; font-weight: 500;">üìÅ ${prompt.category}</span>` : ''}
                        </div>
                    </div>
                    <div style="color: #718096; font-size: 14px; line-height: 1.6; margin-bottom: 12px; max-height: 60px; overflow: hidden; text-overflow: ellipsis;">
                        ${(prompt.text || '').substring(0, 150)}${prompt.text && prompt.text.length > 150 ? '...' : ''}
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="insertPrompt('${prompt.id}')" 
                                style="flex: 1; padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 13px;">
                            ‚úèÔ∏è Insert
                        </button>
                        <button onclick="viewPromptDetails('${prompt.id}')" 
                                style="padding: 8px 16px; background: #f7fafc; color: #4a5568; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 13px;">
                            üëÅÔ∏è View
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function filterPrompts() {
            const searchTerm = document.getElementById('prompt-search').value.toLowerCase();
            
            if (!searchTerm) {
                renderPromptsList(allPrompts);
                return;
            }
            
            const filtered = allPrompts.filter(prompt => 
                (prompt.name && prompt.name.toLowerCase().includes(searchTerm)) ||
                (prompt.text && prompt.text.toLowerCase().includes(searchTerm)) ||
                (prompt.category && prompt.category.toLowerCase().includes(searchTerm))
            );
            
            renderPromptsList(filtered);
        }

        function insertPrompt(promptId) {
            const prompt = allPrompts.find(p => p.id === promptId);
            if (prompt && prompt.text) {
                const input = document.getElementById('chat-input');
                input.value = prompt.text;
                input.style.height = 'auto';
                input.style.height = input.scrollHeight + 'px';
                input.focus();
                closePromptsModal();
                showNotification(`Inserted: ${prompt.name}`, 'success');
            }
        }

        function viewPromptDetails(promptId) {
            const prompt = allPrompts.find(p => p.id === promptId);
            if (prompt) {
                const details = `
Name: ${prompt.name}
Category: ${prompt.category || 'None'}

Text:
${prompt.text || 'No text'}

Created: ${prompt.created_at ? new Date(prompt.created_at).toLocaleString() : 'Unknown'}
                `.trim();
                
                alert(details);
            }
        }

        function saveChatHistory() {
            localStorage.setItem('chat_history', JSON.stringify(messages));
        }

        function loadChatHistory() {
            const saved = localStorage.getItem('chat_history');
            if (saved) {
                try {
                    messages = JSON.parse(saved);
                    // Reload messages into UI if needed
                } catch (e) {
                    console.error('Failed to load chat history:', e);
                }
            }
        }

        function updateWelcomeTime() {
            const timeEl = document.getElementById('welcome-time');
            if (timeEl) {
                timeEl.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        async function loadSystemPrompt() {
            try {
                const response = await fetch('/api/settings/system-prompt');
                if (response.ok) {
                    const data = await response.json();
                    systemPrompt = data.prompt;
                }
            } catch (error) {
                console.error('Error loading system prompt:', error);
            }
        }

        function getContextLimit(model) {
            /**Get context limit for a model.*/
            const limits = {
                'gpt-4-turbo-preview': 128000,
                'gpt-4': 8192,
                'gpt-3.5-turbo': 4096,
                'gpt-3.5-turbo-16k': 16384
            };
            return limits[model] || 4096;
        }
        
        function updateTokenUsage(tokenUsage) {
            const percentage = tokenUsage.percentage || 0;
            const bar = document.getElementById('token-bar');
            const percentageEl = document.getElementById('token-percentage');
            const warningEl = document.getElementById('token-warning');
            
            // Update percentage display
            percentageEl.textContent = `${percentage}%`;
            bar.style.width = `${percentage}%`;
            
            // Update bar color class
            bar.className = 'token-bar-fill';
            if (percentage < 50) {
                bar.classList.add('low');
            } else if (percentage < 80) {
                bar.classList.add('medium');
            } else {
                bar.classList.add('high');
            }
            
            // Show warning if high
            if (tokenUsage.warning) {
                warningEl.textContent = tokenUsage.warning;
                warningEl.style.display = 'inline';
            } else {
                warningEl.style.display = 'none';
            }
        }

        async function saveConversationAuto() {
            if (messages.length <= 1) return; // Don't save empty chats
            
            const model = document.getElementById('model-select').value;
            
            const conversationData = {
                id: currentConversationId,
                messages: messages.filter(m => m.type !== 'system').map(m => ({
                    role: m.type === 'user' ? 'user' : 'assistant',
                    content: m.content
                })),
                model: model,
                system_prompt: systemPrompt
            };
            
            try {
                const response = await fetch('/api/conversations/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(conversationData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    currentConversationId = result.id;
                }
            } catch (error) {
                console.error('Error saving conversation:', error);
            }
        }

        async function loadConversation(conversationId) {
            try {
                const response = await fetch(`/api/conversations/load/${conversationId}`);
                
                if (response.ok) {
                    const conversation = await response.json();
                    
                    // Clear current messages
                    messages = [];
                    document.getElementById('messages-area').innerHTML = '';
                    
                    // Load messages
                    conversation.messages.forEach(msg => {
                        addMessage(msg.role, msg.content);
                    });
                    
                    // Set conversation ID
                    currentConversationId = conversation.id;
                    
                    // Update model if stored
                    if (conversation.model) {
                        document.getElementById('model-select').value = conversation.model;
                    }
                    
                    // Recalculate token usage for loaded conversation
                    const model = conversation.model || document.getElementById('model-select').value;
                    const estimatedTokens = messages.reduce((total, msg) => {
                        return total + Math.ceil(msg.content.length / 4);
                    }, 0);
                    
                    // Update token display
                    updateTokenUsage({
                        prompt_tokens: estimatedTokens,
                        total_tokens: estimatedTokens,
                        context_limit: getContextLimit(model),
                        percentage: Math.min(100, (estimatedTokens / getContextLimit(model)) * 100)
                    });
                    
                    showNotification('Conversation loaded', 'success');
                }
            } catch (error) {
                showNotification('Error loading conversation', 'error');
            }
        }

        // History Modal Functions
        async function openHistoryModal() {
            const modal = document.getElementById('history-modal');
            modal.style.display = 'flex';
            
            // Load conversations
            await loadConversationsList();
        }

        function closeHistoryModal() {
            const modal = document.getElementById('history-modal');
            modal.style.display = 'none';
        }

        async function loadConversationsList() {
            const listContainer = document.getElementById('history-list');
            
            try {
                const response = await fetch('/api/conversations/list?sort=date');
                
                if (response.ok) {
                    const data = await response.json();
                    const conversations = data.conversations || [];
                    
                    if (conversations.length === 0) {
                        listContainer.innerHTML = `
                            <div style="text-align: center; color: #718096; padding: 40px;">
                                <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
                                <div style="font-size: 18px; margin-bottom: 8px;">No conversations yet</div>
                                <div style="font-size: 14px;">Start chatting to create your first conversation!</div>
                            </div>
                        `;
                        return;
                    }
                    
                    // Render conversation list
                    listContainer.innerHTML = conversations.map(conv => `
                        <div style="border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s ease; background: white;"
                             onmouseover="this.style.background='#f7fafc'; this.style.borderColor='#cbd5e0';"
                             onmouseout="this.style.background='white'; this.style.borderColor='#e2e8f0';"
                             onclick="loadConversationFromHistory('${conv.id}')">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div style="font-weight: 600; color: #1a202c; font-size: 16px; flex: 1;">${conv.title || 'Untitled Conversation'}</div>
                                <button onclick="event.stopPropagation(); deleteConversationFromHistory('${conv.id}')" 
                                        style="background: none; border: none; color: #e53e3e; cursor: pointer; font-size: 18px; padding: 0 8px;"
                                        title="Delete conversation">üóëÔ∏è</button>
                            </div>
                            <div style="display: flex; gap: 16px; font-size: 13px; color: #718096;">
                                <span>üí¨ ${conv.message_count || 0} messages</span>
                                <span>üìÖ ${formatDate(conv.updated_at || conv.created_at)}</span>
                                ${conv.model ? `<span>ü§ñ ${conv.model}</span>` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    listContainer.innerHTML = `
                        <div style="text-align: center; color: #e53e3e; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                            <div>Failed to load conversations</div>
                        </div>
                    `;
                }
            } catch (error) {
                listContainer.innerHTML = `
                    <div style="text-align: center; color: #e53e3e; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                        <div>Error: ${error.message}</div>
                    </div>
                `;
            }
        }

        async function loadConversationFromHistory(conversationId) {
            closeHistoryModal();
            await loadConversation(conversationId);
        }

        async function deleteConversationFromHistory(conversationId) {
            if (!confirm('Are you sure you want to delete this conversation?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/conversations/delete/${conversationId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showNotification('Conversation deleted', 'success');
                    await loadConversationsList(); // Reload list
                } else {
                    showNotification('Failed to delete conversation', 'error');
                }
            } catch (error) {
                showNotification('Error deleting conversation', 'error');
            }
        }

        async function deleteAllConversations() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to delete ALL conversations? This cannot be undone!')) {
                return;
            }
            
            // Double confirmation for destructive action
            if (!confirm('This will permanently delete all your conversation history. Continue?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/conversations/list');
                if (response.ok) {
                    const data = await response.json();
                    const conversations = data.conversations || [];
                    
                    if (conversations.length === 0) {
                        showNotification('No conversations to delete', 'success');
                        return;
                    }
                    
                    // Delete all conversations
                    let deleted = 0;
                    for (const conv of conversations) {
                        const delResponse = await fetch(`/api/conversations/delete/${conv.id}`, {
                            method: 'DELETE'
                        });
                        if (delResponse.ok) deleted++;
                    }
                    
                    showNotification(`Deleted ${deleted} conversation(s)`, 'success');
                    await loadConversationsList(); // Reload list
                } else {
                    showNotification('Failed to load conversations', 'error');
                }
            } catch (error) {
                showNotification('Error deleting conversations', 'error');
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString();
        }

        // Regenerate Last Response
        async function regenerateLastResponse() {
            if (messages.length < 2 || isLoading) return;
            
            // Find the last user message
            let lastUserMessage = null;
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].type === 'user') {
                    lastUserMessage = messages[i];
                    break;
                }
            }
            
            if (!lastUserMessage) {
                showNotification('No user message to regenerate from', 'error');
                return;
            }
            
            // Remove all messages after the last user message (keep the user message)
            const userMessageIndex = messages.indexOf(lastUserMessage);
            messages = messages.slice(0, userMessageIndex + 1);
            
            // Re-render messages
            const messagesArea = document.getElementById('messages-area');
            messagesArea.innerHTML = '';
            messages.forEach(msg => {
                addMessage(msg.type, msg.content);
            });
            
            // Resend the last user message
            await sendMessage(lastUserMessage.content);
        }

        // Helper to update regenerate button state
        function updateRegenerateButton() {
            const hasUserMessages = messages.some(m => m.type === 'user');
            document.getElementById('regenerate-btn').disabled = !hasUserMessages;
        }

        // Helper to update message count display
        function updateMessageCount() {
            const count = messages.filter(m => m.type !== 'system').length;
            document.getElementById('msg-count').textContent = count;
        }
        
        function updateConversationMetadata() {
            // Update message count
            updateMessageCount();
            
            // Update model name
            const modelSelect = document.getElementById('model-select');
            const modelOption = modelSelect.options[modelSelect.selectedIndex];
            document.getElementById('model-name').textContent = modelOption.text.split(' (')[0]; // Get just the name
            
            // Update conversation time (when conversation started)
            if (!window.conversationStartTime) {
                window.conversationStartTime = new Date();
            }
            const elapsed = Math.floor((new Date() - window.conversationStartTime) / 60000); // minutes
            document.getElementById('conv-time').textContent = elapsed > 0 ? `${elapsed}m` : 'Just now';
            
            // Update last message time
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const mins = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('last-msg-time').textContent = `${hours}:${mins}`;
        }

        // Save Conversation Modal Functions
        function openSaveConvModal() {
            if (messages.length === 0 || messages.filter(m => m.type !== 'system').length === 0) {
                showNotification('No messages to save', 'error');
                return;
            }
            
            const modal = document.getElementById('save-conv-modal');
            const input = document.getElementById('conv-title-input');
            
            // Auto-suggest title from first user message
            const firstUserMsg = messages.find(m => m.type === 'user');
            if (firstUserMsg) {
                const suggestedTitle = firstUserMsg.content.substring(0, 50);
                input.value = suggestedTitle + (firstUserMsg.content.length > 50 ? '...' : '');
            }
            
            modal.style.display = 'flex';
            setTimeout(() => input.focus(), 100);
        }

        function closeSaveConvModal() {
            const modal = document.getElementById('save-conv-modal');
            modal.style.display = 'none';
        }

        async function saveConversationWithTitle() {
            const title = document.getElementById('conv-title-input').value.trim();
            
            if (!title) {
                showNotification('Please enter a title', 'error');
                return;
            }
            
            const model = document.getElementById('model-select').value;
            
            const conversationData = {
                id: currentConversationId,
                title: title,
                messages: messages.filter(m => m.type !== 'system').map(m => ({
                    role: m.type === 'user' ? 'user' : 'assistant',
                    content: m.content
                })),
                model: model,
                system_prompt: systemPrompt
            };
            
            try {
                const response = await fetch('/api/conversations/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(conversationData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    currentConversationId = result.id;
                    closeSaveConvModal();
                    showNotification(`Saved: ${title}`, 'success');
                } else {
                    showNotification('Failed to save conversation', 'error');
                }
            } catch (error) {
                showNotification('Error saving conversation', 'error');
            }
        }
    </script>
</body>
</html>
