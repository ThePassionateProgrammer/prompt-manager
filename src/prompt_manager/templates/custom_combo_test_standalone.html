<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Combo Box Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="mb-1">ðŸ§ª Custom Combo Box Test</h2>
                        <p class="text-muted mb-0">Testing dual-mode custom combo box functionality</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-warning" id="mode-toggle">
                            <i class="fas fa-edit me-1"></i>Mode: DISPLAY
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="reset-test">
                            <i class="fas fa-eraser me-1"></i>Reset
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Left Panel: Test Controls -->
            <div class="col-lg-6">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Test Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="test-template" class="form-label fw-bold">Test Template</label>
                            <textarea class="form-control" id="test-template" rows="3" 
                                      placeholder="Enter template with tags...">As a [Role], I want to [What], so that [Why]</textarea>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" id="generate-test">
                                <i class="fas fa-magic me-1"></i>Generate Test Combo Boxes
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="run-tests">
                                <i class="fas fa-vial me-1"></i>Run Tests
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Test Results -->
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Test Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-results">
                            <div class="text-center text-muted">
                                <i class="fas fa-play fa-2x mb-3"></i>
                                <p>Click "Run Tests" to see results</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Panel: Combo Box Testing Area -->
            <div class="col-lg-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Custom Combo Boxes</h5>
                    </div>
                    <div class="card-body">
                        <div id="combo-box-test-container">
                            <div class="text-center text-muted">
                                <i class="fas fa-arrow-up fa-2x mb-3"></i>
                                <p>Click "Generate Test Combo Boxes" to start testing</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    let isEditMode = false;
    let testComboBoxes = [];
    let testResults = [];

    // Load test page
    document.addEventListener('DOMContentLoaded', function() {
        setupTestEventListeners();
    });

    function setupTestEventListeners() {
        // Mode toggle button
        document.getElementById('mode-toggle').addEventListener('click', toggleMode);
        
        // Generate test combo boxes
        document.getElementById('generate-test').addEventListener('click', generateTestComboBoxes);
        
        // Run tests
        document.getElementById('run-tests').addEventListener('click', runTests);
        
        // Reset test
        document.getElementById('reset-test').addEventListener('click', resetTest);
    }

    function toggleMode() {
        isEditMode = !isEditMode;
        updateModeButton();
        
        // Regenerate combo boxes to reflect mode change
        if (testComboBoxes.length > 0) {
            renderTestComboBoxes();
        }
        
        showAlert(`Mode switched to ${isEditMode ? 'EDIT' : 'DISPLAY'}`, 'info');
    }

    function updateModeButton() {
        const button = document.getElementById('mode-toggle');
        if (isEditMode) {
            button.className = 'btn btn-warning';
            button.innerHTML = '<i class="fas fa-edit me-1"></i>Mode: EDIT';
        } else {
            button.className = 'btn btn-outline-warning';
            button.innerHTML = '<i class="fas fa-edit me-1"></i>Mode: DISPLAY';
        }
    }

    function generateTestComboBoxes() {
        const template = document.getElementById('test-template').value.trim();
        
        if (!template) {
            showAlert('Please enter a template', 'error');
            return;
        }
        
        // Extract variables from template
        const variables = extractVariables(template);
        
        // Generate test combo boxes
        testComboBoxes = [];
        variables.forEach((variable, index) => {
            testComboBoxes.push({
                tag: variable,
                index: index,
                enabled: index === 0, // Only first is enabled initially
                value: '',
                options: generateTestOptions(variable),
                is_custom: true
            });
        });
        
        renderTestComboBoxes();
    }

    function extractVariables(template) {
        const pattern = /\[([^\]]+)\]/g;
        const matches = [];
        let match;
        while ((match = pattern.exec(template)) !== null) {
            matches.push(match[1]);
        }
        return matches;
    }

    function generateTestOptions(tag) {
        // Generate test options based on tag
        const testOptions = {
            'Role': ['Manager', 'Programmer', 'Designer', 'Tester'],
            'What': ['Write code', 'Create tests', 'Review code', 'Fix bugs'],
            'Why': ['Improve quality', 'Save time', 'Reduce errors', 'Enhance performance']
        };
        
        return testOptions[tag] || ['Option 1', 'Option 2', 'Option 3'];
    }

    function renderTestComboBoxes() {
        const container = document.getElementById('combo-box-test-container');
        
        if (testComboBoxes.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-arrow-up fa-2x mb-3"></i>
                    <p>Click "Generate Test Combo Boxes" to start testing</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        testComboBoxes.forEach((comboBox, index) => {
            const isFirst = index === 0;
            const isLast = index === testComboBoxes.length - 1;
            
            // Determine mode-specific options and placeholder
            const modeOptions = getModeOptions(comboBox.tag, comboBox.options);
            const placeholder = getModePlaceholder(comboBox.tag);
            
            html += `
                <div class="mb-3 border rounded p-3 bg-light">
                    <label for="test-combo-${index}" class="form-label fw-bold">
                        ${comboBox.tag} ${isFirst ? '(Start here)' : ''} ${isLast ? '(Final selection)' : ''}
                    </label>
                    <div class="input-group">
                        <input type="text" class="form-control" 
                               id="test-combo-${index}" 
                               placeholder="${placeholder}"
                               ${comboBox.enabled ? '' : 'disabled'}
                               data-index="${index}"
                               data-tag="${comboBox.tag}">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
                                data-bs-toggle="dropdown" 
                                ${comboBox.enabled ? '' : 'disabled'}>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <ul class="dropdown-menu" id="test-dropdown-${index}">
                            ${modeOptions.map(option => 
                                `<li><a class="dropdown-item" href="#" data-value="${option}">${option}</a></li>`
                            ).join('')}
                        </ul>
                    </div>
                    <div class="form-text">
                        ${comboBox.enabled ? 'Ready for selection' : 'Waiting for previous selection'}
                        <br><small class="text-muted">Mode: ${isEditMode ? 'EDIT' : 'DISPLAY'}</small>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Add event listeners to test combo boxes
        testComboBoxes.forEach((comboBox, index) => {
            const input = document.getElementById(`test-combo-${index}`);
            const dropdown = document.getElementById(`test-dropdown-${index}`);
            
            // Handle input changes
            input.addEventListener('input', function() {
                handleTestComboBoxChange(index, this.value);
            });
            
            // Handle Enter key for add/edit/delete
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleEnterKey(index, this.value);
                }
            });
            
            // Handle focus/blur for dropdown behavior
            input.addEventListener('focus', function() {
                showDropdown(index);
            });
            
            input.addEventListener('blur', function() {
                // Delay hiding to allow dropdown clicks
                setTimeout(() => hideDropdown(index), 150);
            });
            
            // Handle dropdown selections
            dropdown.addEventListener('click', function(e) {
                if (e.target.classList.contains('dropdown-item')) {
                    e.preventDefault();
                    const value = e.target.getAttribute('data-value');
                    input.value = value;
                    handleTestComboBoxChange(index, value);
                }
            });
        });
    }

    function getModeOptions(tag, baseOptions) {
        if (isEditMode) {
            // Edit mode: First item is "Add item"
            return ['Add item', ...baseOptions];
        } else {
            // Display mode: First item is "Select item"
            return ['Select item', ...baseOptions];
        }
    }

    function getModePlaceholder(tag) {
        if (isEditMode) {
            return `Enter ${tag}`;
        } else {
            return `Select ${tag}`;
        }
    }

    function handleTestComboBoxChange(index, value) {
        testComboBoxes[index].value = value;
        
        // Handle cascading behavior (enable next combo box)
        if (index + 1 < testComboBoxes.length) {
            testComboBoxes[index + 1].enabled = value && value !== 'Select item' && value !== 'Add item';
            const nextInput = document.getElementById(`test-combo-${index + 1}`);
            if (nextInput) {
                nextInput.disabled = !testComboBoxes[index + 1].enabled;
            }
        }
    }

    function runTests() {
        const resultsDiv = document.getElementById('test-results');
        resultsDiv.innerHTML = '<h5>Running Tests...</h5>';
        
        let allPassed = true;
        let results = [];
        
        // Test 1: Mode switching
        results.push(`<h6>Mode Switching Tests:</h6>`);
        if (isEditMode !== null) {
            results.push(`<p class="text-success"><i class="fas fa-check-circle me-1"></i>PASS: Mode state variable exists</p>`);
        } else {
            results.push(`<p class="text-danger"><i class="fas fa-times-circle me-1"></i>FAIL: Mode state variable missing</p>`);
            allPassed = false;
        }
        
        // Test 2: Combo box generation
        results.push(`<h6>Combo Box Generation Tests:</h6>`);
        if (testComboBoxes.length > 0) {
            results.push(`<p class="text-success"><i class="fas fa-check-circle me-1"></i>PASS: Combo boxes generated (${testComboBoxes.length} boxes)</p>`);
        } else {
            results.push(`<p class="text-danger"><i class="fas fa-times-circle me-1"></i>FAIL: No combo boxes generated</p>`);
            allPassed = false;
        }
        
        // Test 3: Mode-specific options
        results.push(`<h6>Mode-Specific Behavior Tests:</h6>`);
        const firstCombo = document.getElementById('test-dropdown-0');
        if (firstCombo) {
            const firstOption = firstCombo.querySelector('a').textContent;
            const expectedOption = isEditMode ? 'Add item' : 'Select item';
            if (firstOption === expectedOption) {
                results.push(`<p class="text-success"><i class="fas fa-check-circle me-1"></i>PASS: First option is "${expectedOption}"</p>`);
            } else {
                results.push(`<p class="text-danger"><i class="fas fa-times-circle me-1"></i>FAIL: First option is "${firstOption}", expected "${expectedOption}"</p>`);
                allPassed = false;
            }
        }
        
        // Test 4: Placeholder text
        const firstInput = document.getElementById('test-combo-0');
        if (firstInput) {
            const placeholder = firstInput.placeholder;
            const expectedPlaceholder = isEditMode ? 'Enter Role' : 'Select Role';
            if (placeholder === expectedPlaceholder) {
                results.push(`<p class="text-success"><i class="fas fa-check-circle me-1"></i>PASS: Placeholder is "${expectedPlaceholder}"</p>`);
            } else {
                results.push(`<p class="text-danger"><i class="fas fa-times-circle me-1"></i>FAIL: Placeholder is "${placeholder}", expected "${expectedPlaceholder}"</p>`);
                allPassed = false;
            }
        }
        
        if (allPassed) {
            results.push('<h4 class="text-success mt-4"><i class="fas fa-check-double me-2"></i>All Tests Passed!</h4>');
        } else {
            results.push('<h4 class="text-danger mt-4"><i class="fas fa-exclamation-triangle me-2"></i>Some Tests Failed!</h4>');
        }
        
        resultsDiv.innerHTML = results.join('');
    }

    function resetTest() {
        isEditMode = false;
        testComboBoxes = [];
        updateModeButton();
        
        document.getElementById('test-template').value = 'As a [Role], I want to [What], so that [Why]';
        document.getElementById('combo-box-test-container').innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-arrow-up fa-2x mb-3"></i>
                <p>Click "Generate Test Combo Boxes" to start testing</p>
            </div>
        `;
        document.getElementById('test-results').innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-play fa-2x mb-3"></i>
                <p>Click "Run Tests" to see results</p>
            </div>
        `;
    }

    // Custom Combo Box Behavior Functions

    function handleEnterKey(index, value) {
        const comboBox = testComboBoxes[index];
        const input = document.getElementById(`test-combo-${index}`);
        
        if (isEditMode) {
            // Edit mode: Add, edit, or delete items
            if (value.trim() === '') {
                // Empty value: delete selected item
                deleteSelectedItem(index);
            } else {
                // Has value: add or update item
                addOrUpdateItem(index, value.trim());
            }
        } else {
            // Display mode: just select the item
            selectItem(index, value);
        }
    }

    function addOrUpdateItem(index, value) {
        const comboBox = testComboBoxes[index];
        const input = document.getElementById(`test-combo-${index}`);
        
        // Add to options if not already there
        if (!comboBox.options.includes(value)) {
            comboBox.options.push(value);
        }
        
        // Clear input and regenerate dropdown
        input.value = '';
        renderTestComboBoxes();
        
        showAlert(`Added "${value}" to ${comboBox.tag}`, 'success');
    }

    function deleteSelectedItem(index) {
        const comboBox = testComboBoxes[index];
        const input = document.getElementById(`test-combo-${index}`);
        
        // Find and remove the selected item
        const selectedValue = input.value;
        if (selectedValue && comboBox.options.includes(selectedValue)) {
            comboBox.options = comboBox.options.filter(opt => opt !== selectedValue);
            input.value = '';
            renderTestComboBoxes();
            showAlert(`Deleted "${selectedValue}" from ${comboBox.tag}`, 'info');
        }
    }

    function selectItem(index, value) {
        const comboBox = testComboBoxes[index];
        const input = document.getElementById(`test-combo-${index}`);
        
        // Just select the item (display mode)
        input.value = value;
        showAlert(`Selected "${value}" in ${comboBox.tag}`, 'info');
    }

    function showDropdown(index) {
        const dropdown = document.getElementById(`test-dropdown-${index}`);
        if (dropdown) {
            dropdown.style.display = 'block';
        }
    }

    function hideDropdown(index) {
        const dropdown = document.getElementById(`test-dropdown-${index}`);
        if (dropdown) {
            dropdown.style.display = 'none';
        }
    }

    function showAlert(message, type) {
        // Create a Bootstrap alert
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 3000);
    }
    </script>
</body>
</html>
