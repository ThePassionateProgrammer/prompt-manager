<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Combo Box Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .combo-box-container {
            position: relative;
            display: inline-block;
            margin: 10px;
        }
        
        .combo-box-input {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            width: 200px;
        }
        
        .combo-box-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        
        .combo-box-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .combo-box-dropdown.show {
            display: block;
        }
        
        .combo-box-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .combo-box-option:hover {
            background-color: #f8f9fa;
        }
        
        .combo-box-option.selected {
            background-color: #007bff;
            color: white;
        }
        
        .combo-box-option.highlighted {
            background-color: #e9ecef;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        
        .test-results {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .button:hover {
            background-color: #0056b3;
        }
        
        .button.secondary {
            background-color: #6c757d;
        }
        
        .button.secondary:hover {
            background-color: #545b62;
        }
    </style>
</head>
<body>
    <h1>Custom Combo Box Test Page</h1>
    
    <div class="test-section">
        <h3>Basic Combo Box</h3>
        <div class="combo-box-container" id="combo1">
            <input type="text" class="combo-box-input" placeholder="Type to add..." id="input1">
            <div class="combo-box-dropdown" id="dropdown1">
                <div class="combo-box-option" data-value="Add...">Add...</div>
                <div class="combo-box-option" data-value="Option 1">Option 1</div>
                <div class="combo-box-option" data-value="Option 2">Option 2</div>
            </div>
        </div>
        <button class="button" onclick="testCombo1()">Test Combo 1</button>
        <button class="button secondary" onclick="resetCombo1()">Reset</button>
    </div>
    
    <div class="test-section">
        <h3>Multiple Combo Boxes (Tab Navigation)</h3>
        <div class="combo-box-container" id="combo2">
            <input type="text" class="combo-box-input" placeholder="Type to add..." id="input2">
            <div class="combo-box-dropdown" id="dropdown2">
                <div class="combo-box-option" data-value="Add...">Add...</div>
                <div class="combo-box-option" data-value="Role 1">Role 1</div>
                <div class="combo-box-option" data-value="Role 2">Role 2</div>
            </div>
        </div>
        <div class="combo-box-container" id="combo3">
            <input type="text" class="combo-box-input" placeholder="Type to add..." id="input3">
            <div class="combo-box-dropdown" id="dropdown3">
                <div class="combo-box-option" data-value="Add...">Add...</div>
                <div class="combo-box-option" data-value="Action 1">Action 1</div>
                <div class="combo-box-option" data-value="Action 2">Action 2</div>
            </div>
        </div>
        <button class="button" onclick="testMultipleCombos()">Test Multiple</button>
        <button class="button secondary" onclick="resetAllCombos()">Reset All</button>
    </div>
    
    <div class="test-section">
        <h3>Test Results</h3>
        <div class="test-results" id="testResults">No tests run yet.</div>
    </div>
    
    <div class="test-section">
        <h3>Instructions</h3>
        <ul>
            <li><strong>Focus</strong> on input field to show dropdown</li>
            <li><strong>Type text</strong> and press <strong>Enter</strong> to replace selected option</li>
            <li><strong>Empty text + Enter</strong> removes selected option</li>
            <li><strong>Select "Add..."</strong> and press <strong>Enter</strong> to add new option</li>
            <li><strong>Arrow keys</strong> to navigate dropdown</li>
            <li><strong>Tab</strong> to move between combo boxes</li>
            <li><strong>Escape</strong> to close dropdown</li>
        </ul>
    </div>

    <script>
        class CustomComboBox {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.input = this.container.querySelector('.combo-box-input');
                this.dropdown = this.container.querySelector('.combo-box-dropdown');
                this.options = Array.from(this.dropdown.querySelectorAll('.combo-box-option'));
                
                this.selectedOption = null;
                this.highlightedIndex = -1;
                this.isDropdownVisible = false;
                
                this.setupEventListeners();
                this.updateOptions();
            }
            
            setupEventListeners() {
                // Focus events
                this.input.addEventListener('focus', () => this.showDropdown());
                this.input.addEventListener('blur', (e) => {
                    // Delay to allow for option clicks
                    setTimeout(() => this.hideDropdown(), 150);
                });
                
                // Key events
                this.input.addEventListener('keydown', (e) => this.handleKeyDown(e));
                
                // Option clicks
                this.options.forEach((option, index) => {
                    option.addEventListener('click', () => this.selectOption(index));
                    option.addEventListener('mouseenter', () => this.highlightOption(index));
                });
                
                // Click outside to close
                document.addEventListener('click', (e) => {
                    if (!this.container.contains(e.target)) {
                        this.hideDropdown();
                    }
                });
            }
            
            handleKeyDown(e) {
                switch(e.key) {
                    case 'Enter':
                        e.preventDefault();
                        this.handleEnter();
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        this.navigateDown();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        this.navigateUp();
                        break;
                    case 'Escape':
                        e.preventDefault();
                        this.hideDropdown();
                        break;
                    case 'Tab':
                        // Let default tab behavior work
                        break;
                }
            }
            
            handleEnter() {
                const entryText = this.input.value.trim();
                
                if (this.selectedOption) {
                    if (entryText === '') {
                        // Remove selected option
                        this.removeOption(this.selectedOption);
                    } else {
                        // Replace selected option
                        this.replaceOption(this.selectedOption, entryText);
                    }
                } else if (this.highlightedIndex >= 0) {
                    const highlightedOption = this.options[this.highlightedIndex];
                    if (highlightedOption.dataset.value === 'Add...') {
                        // Add new option
                        if (entryText !== '') {
                            this.addOption(entryText);
                        }
                    } else {
                        // Select highlighted option
                        this.selectOption(this.highlightedIndex);
                    }
                }
                
                this.input.value = '';
                this.hideDropdown();
            }
            
            navigateDown() {
                if (!this.isDropdownVisible) {
                    this.showDropdown();
                }
                
                this.highlightedIndex = Math.min(this.highlightedIndex + 1, this.options.length - 1);
                this.updateHighlight();
            }
            
            navigateUp() {
                if (!this.isDropdownVisible) {
                    this.showDropdown();
                }
                
                this.highlightedIndex = Math.max(this.highlightedIndex - 1, 0);
                this.updateHighlight();
            }
            
            selectOption(index) {
                if (index < 0 || index >= this.options.length) return;
                
                const option = this.options[index];
                if (option.dataset.value === 'Add...') {
                    // Don't select "Add..." option
                    return;
                }
                
                this.selectedOption = option.dataset.value;
                this.input.value = option.dataset.value;
                this.updateSelection();
            }
            
            highlightOption(index) {
                this.highlightedIndex = index;
                this.updateHighlight();
            }
            
            showDropdown() {
                this.dropdown.classList.add('show');
                this.isDropdownVisible = true;
            }
            
            hideDropdown() {
                this.dropdown.classList.remove('show');
                this.isDropdownVisible = false;
                this.highlightedIndex = -1;
                this.updateHighlight();
            }
            
            updateHighlight() {
                this.options.forEach((option, index) => {
                    option.classList.toggle('highlighted', index === this.highlightedIndex);
                });
            }
            
            updateSelection() {
                this.options.forEach(option => {
                    option.classList.toggle('selected', option.dataset.value === this.selectedOption);
                });
            }
            
            addOption(value) {
                // Add new option after "Add..." option
                const addOption = this.options[0];
                const newOption = document.createElement('div');
                newOption.className = 'combo-box-option';
                newOption.dataset.value = value;
                newOption.textContent = value;
                
                // Add event listeners
                newOption.addEventListener('click', () => this.selectOption(this.options.indexOf(newOption)));
                newOption.addEventListener('mouseenter', () => this.highlightOption(this.options.indexOf(newOption)));
                
                addOption.parentNode.insertBefore(newOption, addOption.nextSibling);
                this.options = Array.from(this.dropdown.querySelectorAll('.combo-box-option'));
                this.selectedOption = value;
                this.updateSelection();
            }
            
            replaceOption(oldValue, newValue) {
                const option = this.options.find(opt => opt.dataset.value === oldValue);
                if (option) {
                    option.dataset.value = newValue;
                    option.textContent = newValue;
                    this.selectedOption = newValue;
                    this.updateSelection();
                }
            }
            
            removeOption(value) {
                const option = this.options.find(opt => opt.dataset.value === value);
                if (option && option.dataset.value !== 'Add...') {
                    option.remove();
                    this.options = Array.from(this.dropdown.querySelectorAll('.combo-box-option'));
                    this.selectedOption = null;
                    this.updateSelection();
                }
            }
            
            updateOptions() {
                this.updateSelection();
            }
            
            // Test methods
            getEntryText() {
                return this.input.value;
            }
            
            getSelectedOption() {
                return this.selectedOption;
            }
            
            getOptions() {
                return this.options.map(opt => opt.dataset.value);
            }
            
            isDropdownVisible() {
                return this.isDropdownVisible;
            }
            
            setEntryText(text) {
                this.input.value = text;
            }
            
            focus() {
                this.input.focus();
            }
        }
        
        // Initialize combo boxes
        let combo1, combo2, combo3;
        
        document.addEventListener('DOMContentLoaded', () => {
            combo1 = new CustomComboBox('combo1');
            combo2 = new CustomComboBox('combo2');
            combo3 = new CustomComboBox('combo3');
        });
        
        // Test functions
        function testCombo1() {
            const results = [];
            results.push('=== Testing Combo Box 1 ===');
            results.push(`Initial options: ${combo1.getOptions().join(', ')}`);
            results.push(`Selected option: ${combo1.getSelectedOption() || 'None'}`);
            results.push(`Entry text: "${combo1.getEntryText()}"`);
            results.push(`Dropdown visible: ${combo1.isDropdownVisible()}`);
            
            document.getElementById('testResults').textContent = results.join('\n');
        }
        
        function testMultipleCombos() {
            const results = [];
            results.push('=== Testing Multiple Combo Boxes ===');
            results.push(`Combo 2 options: ${combo2.getOptions().join(', ')}`);
            results.push(`Combo 3 options: ${combo3.getOptions().join(', ')}`);
            results.push(`Combo 2 selected: ${combo2.getSelectedOption() || 'None'}`);
            results.push(`Combo 3 selected: ${combo3.getSelectedOption() || 'None'}`);
            
            document.getElementById('testResults').textContent = results.join('\n');
        }
        
        function resetCombo1() {
            combo1.input.value = '';
            combo1.selectedOption = null;
            combo1.hideDropdown();
            combo1.updateSelection();
        }
        
        function resetAllCombos() {
            [combo1, combo2, combo3].forEach(combo => {
                if (combo) {
                    combo.input.value = '';
                    combo.selectedOption = null;
                    combo.hideDropdown();
                    combo.updateSelection();
                }
            });
        }
    </script>
</body>
</html>
